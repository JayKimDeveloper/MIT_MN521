
# ===================================================================
# ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± í”Œë ˆì´ë¶ (Rollback Customer A Expansion)
# íŒŒì¼ëª…: scenario1-rollback.yml
#
# ëª©ì : ì‹œë‚˜ë¦¬ì˜¤ 1ì—ì„œ ì¶”ê°€ëœ Customer A í™•ì¥ ì„¤ì •ì„ ì œê±°
# ë°ëª¨ ì¤€ë¹„ë¥¼ ìœ„í•œ í™˜ê²½ ì •ë¦¬
# ===================================================================
---
- name: "ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± - ì´ˆê¸°í™” ë° ë³€ìˆ˜ í™•ì¸"
  hosts: localhost
  gather_facts: true
  vars:
    # ë¡¤ë°±í•  ì„¤ì • ì •ë³´
    rollback:
      customer_id: "A"
      customer_name: "Customer A"
      vlan_to_remove: 105
      network_to_remove: "10.100.50.0"
      netmask_to_remove: "255.255.255.0"
      target_dist: "dist2-sw"
      target_access: "access-sw4"
      core_next_hop: "10.0.2.2"
      dist_interface: "FastEthernet1/0"

    log_prefix: "[ROLLBACK]"

  tasks:
    - name: "ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± ì‹œì‘"
      debug:
        msg: |
          ================================================
          ğŸ”„ ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°±: Customer A í™•ì¥ ì„¤ì • ì œê±°
          ================================================
          ì œê±°í•  ì„¤ì •:
          - ê³ ê° ID: {{ rollback.customer_id }}
          - VLAN: {{ rollback.vlan_to_remove }}
          - ë„¤íŠ¸ì›Œí¬: {{ rollback.network_to_remove }}/24
          - ëŒ€ìƒ ì¥ë¹„: {{ rollback.target_dist }}
          ================================================
          âš ï¸  ë°ëª¨ ì¤€ë¹„ë¥¼ ìœ„í•œ í™˜ê²½ ì •ë¦¬
          ================================================

- name: "Core Router - Customer A í™•ì¥ ë¼ìš°íŒ… ì œê±°"
  hosts: core
  gather_facts: false
  vars:
    rollback: "{{ hostvars['localhost']['rollback'] }}"
    log_prefix: "{{ hostvars['localhost']['log_prefix'] }}"

  tasks:
    - name: "{{ log_prefix }} Core Router í˜„ì¬ ë¼ìš°íŒ… í™•ì¸"
      ios_command:
        commands:
          - "show ip route {{ rollback.network_to_remove }}"
      register: current_route
      ignore_errors: true

    - name: "{{ log_prefix }} ê¸°ì¡´ ë¼ìš°íŒ… ìƒíƒœ"
      debug:
        msg: |
          í˜„ì¬ ë¼ìš°íŒ… ìƒíƒœ:
          {{ current_route.stdout[0] if current_route is succeeded else 'ë¼ìš°íŒ… ì—†ìŒ' }}

    - name: "{{ log_prefix }} Customer A í™•ì¥ ë¼ìš°íŒ… ì œê±°"
      ios_config:
        lines:
          - "no ip route {{ rollback.network_to_remove }} {{ rollback.netmask_to_remove }} {{ rollback.core_next_hop }}"
        save_when: modified
      register: core_removal_result
      ignore_errors: true

    - name: "{{ log_prefix }} Core Router ë¼ìš°íŒ… ì œê±° ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Core Router ë¼ìš°íŒ… ì œê±° ì™„ë£Œ' if core_removal_result is succeeded else 'âš ï¸  ë¼ìš°íŒ…ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì œê±° ì‹¤íŒ¨' }}
          - ì œê±°ëœ ë¼ìš°íŒ…: {{ rollback.network_to_remove }}/24 â†’ {{ rollback.core_next_hop }}

- name: "Distribution Switch - Customer A VLAN ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±°"
  hosts: distribution
  gather_facts: false
  vars:
    rollback: "{{ hostvars['localhost']['rollback'] }}"
    log_prefix: "{{ hostvars['localhost']['log_prefix'] }}"

  tasks:
    - name: "{{ log_prefix }} {{ rollback.target_dist }} í˜„ì¬ ì„œë¸Œì¸í„°í˜ì´ìŠ¤ í™•ì¸"
      ios_command:
        commands:
          - "show interface {{ rollback.dist_interface }}.{{ rollback.vlan_to_remove }}"
      register: current_subint
      ignore_errors: true
      when: inventory_hostname == rollback.target_dist

    - name: "{{ log_prefix }} ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
      debug:
        msg: |
          ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ìƒíƒœ:
          {{ 'ì¡´ì¬í•¨ - ì œê±° ì§„í–‰' if current_subint is succeeded else 'ì¡´ì¬í•˜ì§€ ì•ŠìŒ' }}
      when: inventory_hostname == rollback.target_dist

    - name: "{{ log_prefix }} Customer A VLAN ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±°"
      ios_config:
        lines:
          - "no interface {{ rollback.dist_interface }}.{{ rollback.vlan_to_remove }}"
        save_when: modified
      when: inventory_hostname == rollback.target_dist
      register: dist_removal_result
      ignore_errors: true

    - name: "{{ log_prefix }} Distribution ìŠ¤ìœ„ì¹˜ ì œê±° ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… ' + rollback.target_dist + ' VLAN ' + rollback.vlan_to_remove|string + ' ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±° ì™„ë£Œ' if dist_removal_result is succeeded else 'âš ï¸  ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±° ì‹¤íŒ¨ ë˜ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ' }}
      when: inventory_hostname == rollback.target_dist

- name: "Access Switch ìˆ˜ë™ ì •ë¦¬ ê°€ì´ë“œ ìƒì„±"
  hosts: localhost
  gather_facts: true
  vars:
    rollback: "{{ hostvars['localhost']['rollback'] }}"
    log_prefix: "{{ hostvars['localhost']['log_prefix'] }}"

  tasks:
    - name: "logs ë””ë ‰í† ë¦¬ ìƒì„±"
      file:
        path: "./logs"
        state: directory

    - name: "{{ log_prefix }} Access Switch ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"
      copy:
        content: |
          #!/bin/bash
          # {{ rollback.target_access }} ìˆ˜ë™ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸
          # {{ rollback.customer_name }} í™•ì¥ ì„¤ì • ì œê±°
          # ìƒì„±ì¼: {{ ansible_date_time.iso8601 }}

          echo "================================================"
          echo "{{ rollback.target_access }} ìˆ˜ë™ ì •ë¦¬ ê°€ì´ë“œ"
          echo "================================================"
          echo ""
          echo "âš ï¸  ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê°€ì´ë“œìš©ì…ë‹ˆë‹¤. Access ìŠ¤ìœ„ì¹˜ì— ì½˜ì†”ë¡œ ì ‘ì†í•˜ì—¬ ìˆ˜ë™ ì‹¤í–‰í•˜ì„¸ìš”."
          echo ""
          echo "1. {{ rollback.target_access }}ì— ì½˜ì†” ì ‘ì†"
          echo ""
          echo "2. VLAN {{ rollback.vlan_to_remove }} ê´€ë ¨ ì„¤ì • í™•ì¸:"
          echo "Switch# show vlan brief"
          echo "Switch# show interface status | include {{ rollback.vlan_to_remove }}"
          echo ""
          echo "3. í¬íŠ¸ì—ì„œ VLAN ì œê±° (í•„ìš”ì‹œ):"
          echo "Switch> enable"
          echo "Switch# configure terminal"
          echo "Switch(config)# interface range fastEthernet0/1-2"
          echo "Switch(config-if-range)# switchport access vlan 1"
          echo "Switch(config-if-range)# exit"
          echo ""
          echo "4. VLAN {{ rollback.vlan_to_remove }} ì‚­ì œ:"
          echo "Switch(config)# no vlan {{ rollback.vlan_to_remove }}"
          echo "Switch(config)# exit"
          echo "Switch# write memory"
          echo ""
          echo "5. ì„¤ì • í™•ì¸:"
          echo "Switch# show vlan brief"
          echo ""
          echo "================================================"
        dest: "./logs/{{ rollback.target_access }}_cleanup_vlan{{ rollback.vlan_to_remove }}.sh"
        mode: '0755'

    - name: "{{ log_prefix }} VPCS ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"
      copy:
        content: |
          #!/bin/bash
          # VPCS ì„¤ì • ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸
          # {{ rollback.customer_name }} í™•ì¥ ì„¤ì • ì œê±°
          # ìƒì„±ì¼: {{ ansible_date_time.iso8601 }}

          echo "================================================"
          echo "VPCS ìˆ˜ë™ ì •ë¦¬ ê°€ì´ë“œ"
          echo "================================================"
          echo ""
          echo "{{ rollback.target_access }}ì— ì—°ê²°ëœ VPCSë“¤ì˜ ì„¤ì • ì´ˆê¸°í™”:"
          echo ""
          echo "ê° VPCSì—ì„œ ë‹¤ìŒ ëª…ë ¹ ì‹¤í–‰:"
          echo ""
          echo "VPCS-A4 ì •ë¦¬:"
          echo "VPCS> ip dhcp"
          echo "VPCS> save"
          echo ""
          echo "VPCS-A5 ì •ë¦¬:"
          echo "VPCS> ip dhcp"
          echo "VPCS> save"
          echo ""
          echo "ë˜ëŠ” IP ì™„ì „ ì œê±°:"
          echo "VPCS> clear ip"
          echo "VPCS> save"
          echo ""
          echo "ì„¤ì • í™•ì¸:"
          echo "VPCS> show ip"
          echo ""
          echo "================================================"
        dest: "./logs/vpcs_cleanup_{{ rollback.customer_id }}_vlan{{ rollback.vlan_to_remove }}.sh"
        mode: '0755'

- name: "ì—°ê²°ì„± í™•ì¸ ë° ì •ë¦¬ ê²€ì¦"
  hosts: localhost
  gather_facts: false
  vars:
    rollback: "{{ hostvars['localhost']['rollback'] }}"
    log_prefix: "{{ hostvars['localhost']['log_prefix'] }}"

  tasks:
    - name: "{{ log_prefix }} Coreì—ì„œ ì œê±°ëœ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ í…ŒìŠ¤íŠ¸"
      ios_command:
        commands:
          - "ping {{ rollback.network_to_remove }}"
      register: ping_test
      delegate_to: "{{ groups['core'][0] }}"
      ignore_errors: true

    - name: "{{ log_prefix }} ë„¤íŠ¸ì›Œí¬ ì œê±° ê²€ì¦ ê²°ê³¼"
      debug:
        msg: |
          ğŸ” ë„¤íŠ¸ì›Œí¬ ì œê±° ê²€ì¦:
          {{ 'âœ… ë„¤íŠ¸ì›Œí¬ ì œê±° í™•ì¸ë¨ (ping ì‹¤íŒ¨ ì •ìƒ)' if ping_test is failed else 'âš ï¸  ë„¤íŠ¸ì›Œí¬ê°€ ì•„ì§ ì ‘ê·¼ ê°€ëŠ¥í•¨' }}

- name: "ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± ì™„ë£Œ"
  hosts: localhost
  gather_facts: false
  vars:
    rollback: "{{ hostvars['localhost']['rollback'] }}"

  tasks:
    - name: "ğŸ‰ ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± ì™„ë£Œ"
      debug:
        msg: |
          ================================================
          âœ… ì‹œë‚˜ë¦¬ì˜¤ 1 ë¡¤ë°± ì™„ë£Œ: Customer A í™•ì¥ ì„¤ì • ì œê±°
          ================================================

          ìë™ ì œê±° ì™„ë£Œ:
          - âœ… Core Router: {{ rollback.network_to_remove }}/24 ë¼ìš°íŒ… ì œê±°
          - âœ… {{ rollback.target_dist }}: VLAN {{ rollback.vlan_to_remove }} ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±°

          ğŸ“‹ ìˆ˜ë™ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ:
          ================================================
          - ./logs/{{ rollback.target_access }}_cleanup_vlan{{ rollback.vlan_to_remove }}.sh
          - ./logs/vpcs_cleanup_{{ rollback.customer_id }}_vlan{{ rollback.vlan_to_remove }}.sh

          ğŸ“ ë‹¤ìŒ ìˆ˜ë™ ì‘ì—…:
          ================================================
          1. {{ rollback.target_access }} ì½˜ì†” ì ‘ì† í›„ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì°¸ì¡°
          2. VLAN {{ rollback.vlan_to_remove }} ì œê±° ë° í¬íŠ¸ ì´ˆê¸°í™”
          3. VPCS ì„¤ì • ì´ˆê¸°í™” (ìŠ¤í¬ë¦½íŠ¸ ì°¸ì¡°)

          ğŸ­ ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ: ê¹¨ë—í•œ í™˜ê²½ì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ 1 ì¬ì‹¤í–‰ ê°€ëŠ¥
          ================================================

    - name: "ë¡¤ë°± ì™„ë£Œ ì •ë³´ ì €ì¥"
      copy:
        content: |
          # Customer A í™•ì¥ ë¡¤ë°± ì™„ë£Œ ì •ë³´
          # ìƒì„±ì¼: {{ ansible_date_time.iso8601 }}

          ë¡¤ë°± ì •ë³´:
            ê³ ê° ID: {{ rollback.customer_id }}
            ì œê±°ëœ VLAN: {{ rollback.vlan_to_remove }}
            ì œê±°ëœ ë„¤íŠ¸ì›Œí¬: {{ rollback.network_to_remove }}/24

          ì œê±°ëœ ì¥ë¹„ ì„¤ì •:
            Core Router: ë¼ìš°íŒ… ì œê±° ì™„ë£Œ
            {{ rollback.target_dist }}: ì„œë¸Œì¸í„°í˜ì´ìŠ¤ ì œê±° ì™„ë£Œ
            {{ rollback.target_access }}: ìˆ˜ë™ ì •ë¦¬ í•„ìš”

          ìƒíƒœ: ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ
        dest: "./logs/rollback_{{ rollback.customer_id }}_vlan{{ rollback.vlan_to_remove }}_{{ ansible_date_time.epoch }}.log"
